    <div class="container profile">   
        <div class="row align-items-center">
            <div class="card-header m-auto">
                <h2 class="form-title text-center mx-auto my-3"> 
                    <i class="bi bi-person-fill-lock me-2 d-none d-md-inline"></i>
                        <span class="d-inline profile-title-text">CAMBIA PASSWORD</span>
                    <i class="bi bi-lock-fill ms-2 d-none d-md-inline"></i>
                </h2>
            </div>     

            <h4 class="form-subtitle mx-auto my-3"> 
                <i class="bi bi-1-circle"></i> Inserire la <b style="color: #6d1741">vecchia</b> password. <br>
                <i class="bi bi-2-circle"></i> Inserire la <b style="color: #6d1741">nuova</b> password. <br>
                <i class="bi bi-3-circle "></i> <b style="color: #6d1741">Ripetere</b> la nuova password per confermare il cambio.
            </h4>

            <form id="password-change" action="profile-password" method="POST" novalidate>
                <input type="hidden" name="id_user" id="id_user" value="{{ user.id_user }}" />
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

                <div class="card-body row">
                    <div class="row form-group mb-2">
                        <label for="pass" class="col-5 form-control-label my-1"> Password: </label>

                        <div class="col-6">
                            <input name="pass" type="password" id="pass" 
                                class="form-control {% if errors.pass %}is-invalid{% endif %}" />

                            <div class="error-placeholder">
                                {% if errors.pass %}<div class="invalid-feedback">{{ errors.pass }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row form-group mb-2">
                        <label for="newPass" class="col-5 form-control-label my-1"> Nuova password: </label>

                        <div class="col-6">
                            <input name="newPass" type="password" id="newPass" 
                                class="form-control {% if errors.newPass %}is-invalid{% endif %}" />

                            <div class="error-placeholder">
                                {% if errors.newPass %}<div class="invalid-feedback">{{ errors.newPass }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row form-group mb-2">
                        <label for="confirm" class="col-5 form-control-label my-1"> Conferma password: </label>

                        <div class="col-6">
                            <input name="confirm" type="password" id="confirm" 
                                class="form-control {% if errors.confirm %}is-invalid{% endif %}" />

                            <div class="error-placeholder">
                                {% if errors.confirm %}<div class="invalid-feedback">{{ errors.confirm }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer mx-auto">      
                    <button type="submit" class="my-3 action-button save" name="update_password">
                        <span class="m-auto">
                            SALVA <i class="bi bi-check-circle"></i>
                        </span>
                    </button>
                </div> 
            </form>
        </div>
    </div>

{% block scripts %}    
    {# jQuery (must be first) #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
        crossorigin="anonymous">
</script>
    {# jQuery Validation (depends on jQuery) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/jquery.validate.min.js" 
        integrity="sha512-KFHXdr2oObHKI9w4Hv1XPKc898mE4kgYx58oqsc/JqqdLMDI4YjOLzom+EMlW8HFUd0QfjfAvxSL6sEq/a42fQ==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer">
</script>
    {# jQuery Additional Methods (depends on jQuery) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/additional-methods.min.js" 
        integrity="sha512-owaCKNpctt4R4oShUTTraMPFKQWG9UdWTtG6GRzBjFV4VypcFi6+M3yc4Jk85s3ioQmkYWJbUl1b2b2r41RTjA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer">
</script>
    {# Bootstrap JS bundle (includes modal) #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" 
        crossorigin="anonymous">
</script> 
<script>
$(document).ready(function(){
    $("#password-change").validate({
        onfocusout: function(element) {
            $(element).valid();     // validate the field when it loses focus
        },
        rules: {
            pass: { required: true },
            newPass: { required: true, minlength: 8, pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*[\d\W]).{8,}$/ },//"^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])([A-Za-z0-9-_!?/*+]*).{8,}$" },
            confirm: { required: true, equalTo: "#newPass" }
        },
        messages: {
            pass: "Campo obbligatorio.",
            newPass: {
                required: "Campo obbligatorio.",
                minlength: "Password deve contenere almeno 8 caratteri.",
                pattern: "Password deve contenere min. 1 maiuscola, 1 minuscola e 1 numero o carattere speciale."
            },
            confirm: {
                required: "Campo obbligatorio.",
                equalTo: "La nuova password e la conferma non coincidono."
            } 
        },
        errorPlacement: function (error, element) {
            error.addClass("text-danger small");
            element.addClass("is-invalid");                                             // Bootstrap error class
            element.closest(".form-group").find(".error-placeholder").html(error);      // Insert error inside the reserved space
        },
        highlight: function (element) {
            $(element).addClass('is-invalid');
            $(element).removeClass('is-valid');
        },
        unhighlight: function (element) {
            $(element).removeClass('is-invalid');
            $(element).addClass('is-valid');
            $(element).closest('.form-group').find('.error-placeholder').html('');
        },
        submitHandler: function (form) {
            const $form = $(form);

            $.ajax({
                url: 'profile-password',
                type: 'POST',
                data: $form.serialize(),
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        showTopMessage('Password aggiornata con successo.', 'success');
                        // Switch to overview tab
                        const overviewTab = new bootstrap.Tab($('#p-overview')[0]);
                        overviewTab.show();
                    } else if (response.errors) {
                        $.each(response.errors, function (field, message) {
                            const input = $('[name="' + field + '"]');
                            input.addClass('is-invalid');
                            input.next('.error-placeholder').html('<div class="invalid-feedback">' + message + '</div>');
                        });
                    }
                },
                error: function () {
                    alert('Si Ã¨ verificato un errore.');
                }
            });

            return false;
        }
    });   
    
//  Additional validation for the current password (using AJAX)
    $("#pass").on('focusout', function() {
        const pass = $(this).val(); // Get entered current password
        const csrfToken = $('input[name="csrf_token"]').val();

        $.ajax({
            url: 'check-password',  // Endpoint to verify the current password
            type: 'POST',
            data: { password: pass, csrf_token: csrfToken },
            dataType: 'json',
            success: function(response) {
                if (!response.success) {
                    $('#pass').addClass('is-invalid'); // Invalid password
                    $('.error-placeholder').html('<div class="invalid-feedback">' + response.message + '</div>');
                } else {
                    $('#pass').removeClass('is-invalid').addClass('is-valid'); // Valid current password
                }
            },
            error: function() {
                alert('An error occurred while verifying the current password.');
            }
        });
    });
    
    function showTopMessage(message, type) {
        var $msg = $('<div class="alert alert-' + 
                        type + 
                    ' alert-dismissible fade show" role="alert" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1050;min-width:300px;">' +
                        message +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>');
            $('body').append($msg);

        setTimeout(function() {
            $msg.fadeOut(500, function() {
                $(this).remove();
            });
        }, 3000); // Message disappears after 3 seconds
    }
});    
</script> 
{% endblock %}