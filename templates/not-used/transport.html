{% extends 'admin/layout.html' %}
{% block title %} Crea Trasporto {% endblock %}

{% block content %} 
    <section class="grid-container my-auto mx-auto d-flex justify-content-center">
        <form id="msform" action="{{ doc_root }}admin/transport" method="POST">

                        <!--    ===>    PROGRESS BAR    <===    -->
            <div class="container mb-2 pb-2" style="max-width: 45rem">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100"
                        style="background: rgb(238,9,121); background: radial-gradient(circle, rgba(238,9,121,1) 35%, rgba(227,103,163,1) 100%)">
                    </div>
                </div>
            </div>
                        <!--    ===>    END PROGRESS BAR    <===    -->
                            
                        <!--    ===>    FIELDSET 1 [ADD/EDIT TRANSPORT]    <===    -->
            <fieldset>
                <div class="form-card pt-0">
                    <div class="form-title row mt-2 pt-0 mx-auto">
                        <h2 class="fs-title"> 
                            <i class="bi bi-truck-front"></i> 
                                &nbsp;Trasporto&nbsp; 
                            <i class="bi bi-truck-front"></i> 
                        </h2>
                        
                        <h3 class="fs-subtitle pt-0 mt-0"> 
                            Inserire i dati richiesti per creare il nuovo trasporto. 
                        </h3>
                    </div>

                    <div class="form-group row mx-auto my-0 px-3 py-0">        
                        <div class="col-lg-6">
                            <label for="slot" class="form-control-label mb-0"> Slot ID </label>
                            <input type="text" class="form-control" name="slot" />
                        </div>
                                    
                        <div class="col-lg-6">
                            <label for="cmr" class="form-control-label mb-0"> Numero CMR </label>
                            <input type="text" class="form-control" name="cmr" />
                        </div>
                        
                        <div class="col-lg-3">
                            <label class="form-control-label mb-0" for="type"> Tipo </label>
                                <select class="form-control" name="type" id="type">
                                    <option class="opt-type"></option>   
                                
                                    <option value="F" class="opt-type"> 
                                        Pieno
                                    </option>
                                    
                                    <option value="P" class="opt-type"> 
                                        Parziale
                                    </option>
                                </select>
                        </div>
                                    
                        <div class="col-lg-3">
                            <label for="issuer" class="form-control-label mb-0"> Ditta emittente </label>
                            <input type="text" class="form-control" name="issuer" />
                        </div>
                                
                        <div class="col-lg-3">
                            <label for="supplier" class="form-control-label mb-0"> Fornitore </label>
                            <input type="text" class="form-control" name="supplier" />
                        </div>
                                
                        <div class="col-lg-3">
                            <label for="transport" class="form-control-label mb-0"> Trasporto </label>
                            <input type="text" class="form-control" name="transport" />
                        </div>

                        <div class="col-lg-4">
                            <label for="date_load" class="form-control-label mb-0" data-toggle="tooltip" title="-- Terminale"> Data carico </label>
                            <input type="text" class="form-control date" name="date_load" />
                        </div>
                                    
                        <div class="col-lg-4">
                            <label for="date_unload" class="form-control-label mb-0" data-toggle="tooltip" title="-- Padova"> Data scarico </label>
                            <input type="text" class="form-control date" name="date_unload" />
                        </div>
                                
                        <div class="col-lg-4"> 
                            <label for="container" class="form-control-label mb-0"> Container </label>
                            <input type="text" class="form-control" name="container" />
                        </div>
                                    
                        <div class="col-lg-12">
                            <label for="note" class="form-control-label mb-0"> Nota </label>
                            <textarea rows="2" style="height: 80px; text-align: center" class="form-control" name="note"></textarea>
                        </div>
                    </div>    
                </div>
                        
                <button type="button" name="back" class="reset action-button mb-3 mt-1" style="position: absolute; left: 4rem" onclick="history.back();"> Esci </button>
                <button type="button" name="next" class="next action-button mb-3 mt-1" style="position: absolute; right: 4rem"> Avanti </button>
            </fieldset>
                        <!--    ===>    END FIELDSET 1 [ADD/EDIT TRANSPORT]    <===    -->

                        <!--    ===>    FIELDSET 2 [ADD/EDIT QUANTITY]    <===    -->
            <fieldset>
                <div class="form-card pt-0 quantity">
                    <div class="form-title row mt-2 pt-0 mx-auto">
                        <h2 class="fs-title"> 
                            <i class="bi bi-truck"></i> 
                                &nbsp;Quantità&nbsp; 
                            <i class="bi bi-truck"></i> 
                        </h2>
                        
                        <h3 class="fs-subtitle pt-0 mt-0"> 
                            Inserire le quantità del nuovo trasporto. 
                        </h3>
                    </div>
                        
                    <div class="form-group row mx-auto my-0 px-3 py-0">
                        <div class="col-lg-5">
                            <label for="kg_load" class="form-control-label mb-0" data-toggle="tooltip" title="-- Quantità nominale [ kg ]"> 
                                Quantità caricata 
                            </label>
                            <input type="text" class="form-control" name="kg_load" />
                        </div>        
                        &nbsp;  
                              
                        <div class="col-lg-5">
                            <label class="form-control-label mb-0" for="cooling"> Raffreddamento </label>
                                <select class="form-control" name="cooling" id="cooling">
                                    <option class="opt-type" value=""></option>   
                                
                                    <option value="1" class="opt-type"> 
                                        Sì - 600
                                    </option>
                                    
                                    <option value="0" class="opt-type"> 
                                        No
                                    </option>
                                </select>
                        </div>  
                        &nbsp;
                            
                        <div class="col-lg-5">
                            <label class="form-control-label mb-0" for="price_typology"> Tipologia costo </label>
                            <select class="form-control" name="price_typology" id="price_typology">
                                <option class="opt-type" value=""></option>
                                
                                <option class="opt-type" value="Si">
                                    Sì
                                </option>
                                
                                <option class="opt-type" value="No">
                                    No
                                </option>
                            </select>
                        </div> 
                        &nbsp;
                            
                        <div class="col-lg-5">
                            <label for="price_value" class="form-control-label mb-0 price_value"> Valore costo </label>
                            <input type="text" class="form-control" name="price_value" id="price_value" value="" />
                        </div>
                        &nbsp;
                            
                        <div class="col-lg-5">
                            <label for="kg_unload" class="form-control-label mb-0" data-toggle="tooltip" title="-- [ kg ]"> 
                                Quantità scaricata PD 
                            </label>
                            <input type="text" class="form-control" name="kg_unload" value=""/>
                        </div>
                        &nbsp;
                            
                        <div class="col-lg-5">
                            <label for="liquid_density" class="form-control-label mb-0" data-toggle="tooltip" title="-- [ kg &frasl; m³ ]"> 
                                Densità (liquido) 
                            </label>
                            <input type="text" class="form-control" name="liquid_density" value=""/>
                        </div>
                        &nbsp;
                            
                        <div class="col-lg-5">
                            <label for="gas_weight" class="form-control-label mb-0" data-toggle="tooltip" title="-- [ kg &frasl; Nm³ ]"> 
                                Peso specifico (gas)
                            </label>
                            <input type="text" class="form-control" name="gas_weight" value=""/>
                        </div>
                        &nbsp;
                            
                        <div class="col-lg-5">
                            <label for="pcs_ghv" class="form-control-label mb-0"> PCS/GHV </label>
                            <input type="text" class="form-control" name="pcs_ghv" value=""/>
                        </div>
                    </div>          
                </div>

                <button type="button" name="previous" class="previous action-button mb-3 mt-1" style="position: absolute; left: 4rem"> Indietro </button>
                <button type="button" name="next" class="next action-button mb-3 mt-1" style="position: absolute; right: 4rem"> Avanti </button>
            </fieldset>
                        <!--    ===>    END FIELDSET 2 [ADD/EDIT QUANTITY]    <===    -->

                        <!--    ===>    FIELDSET 3 [ADD/EDIT PARTIAL IF TYPE == 1]   <===    -->
            <fieldset>
                <div class="form-card pt-0 partials">
                    <div class="form-title row mt-2 pt-0 mx-auto">
                        <h2 class="fs-title"> 
                            <i class="bi bi-truck"></i> 
                                &nbsp;Parziali&nbsp; 
                            <i class="bi bi-truck"></i> 
                        </h2>
                        
                        <h3 class="fs-subtitle pt-0 mt-0"> 
                            Inserire gli scarichi parziali del nuovo trasporto.
                        </h3>
                    </div>

                    <div class="form-group row mx-auto my-1 px-2 py-2 table-responsive" style="max-height: 347px" enctype="multipart/form-data">
                        <table id="partials" class="table table-sm table-borderless">
                            <tr class="mx-1 mb-0 pb-1">
                                <th class="mx-auto p-1"> # </th>
                                <th class="mx-auto p-1" data-toggle="tooltip" title="-- Dest. cliente"> Destinazione </th>
                                <th class="mx-auto p-1"> EXW </th>
                                <th class="mx-auto p-1" data-toggle="tooltip" title="-- Data scarico"> Data </th>
                                <th class="mx-auto p-1" data-toggle="tooltip" title="-- Luogo scarico"> Luogo </th>
                                <th class="mx-auto p-1" data-toggle="tooltip" title="-- Quantità scaricata [ kg ]"> Quantità </th>
                                <th class="mx-auto p-1" data-toggle="tooltip" title="-- Rif."> Fattura </th>
                                <th class="mx-auto p-1" style="font-size: 17px"> <i class="bi bi-info-square"></i> </th>                   
                            </tr>
                              
                            <tr class="mx-auto my-0 pt-1">
                                <td>
                                    <input type="hidden" name="tbl_id[]" value="" id="id_partial"/>
                                </td>
                          
                                <td class="col-md-3">
                                    <input type="text" name="destination[]" class="form-control" value=""/> 
                                </td>

                                <td class="col-md-2">
                                    <select class="form-control" name="exw[]">
                                        <option value=""></option>
                                        <option value="fos"> FOS </option>
                                        <option value="destino"> DESTINO </option>
                                    </select>
                                </td>
                                            
                                <td class="col-md-2"> 
                                    <input type="text" class="form-control date" name="date[]" autocomplete="off" value=""/>
                                </td>
                        
                                <td class="col-md-2">
                                    <input type="text" class="form-control" name="place[]" value="" />
                                </td>
                        
                                <td class="col-md-2">
                                    <input type="text" class="form-control mx-auto" name="q_unloaded[]" value="" />
                                </td>
                        
                                <td class="col">
                                    <input type="text" class="form-control mx-auto" name="invoice[]" value=""/>
                                </td>

                                <td class="col d-flex my-auto pt-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm d-flex justify-content-center m-auto p-0" 
                                        style="text-align: center; height: 30px; width: 30px; border-radius: 50%" onclick="partRows.delRow(this)">
                                            <i class="bi bi-x my-auto"></i>
                                    </button>
                                    
                                    &nbsp;
                                    
                                    <button type="button" class="btn btn-outline-primary btn-sm d-flex justify-content-center m-auto p-0" 
                                        style="text-align: center; height: 30px; width: 30px; border-radius: 50%" onclick="partRows.addRow(this)">
                                            <i class="bi bi-plus my-auto"></i>
                                    </button>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <button type="button" name="previous" class="previous action-button mb-3 mt-1" style="position: absolute; left: 4rem"> Indietro </button>
                <button type="button" name="add" class="add action-button mb-3 mt-1 mx-auto" onclick="partRows.addRow()"> Aggiungi </button>
                <button type="button" name="next" class="next action-button mb-3 mt-1" style="position: absolute; right: 4rem"> Avanti </button>     
            </fieldset>
                        <!--    ===>    END FIELDSET 3 [ADD/EDIT PARTIAL IF TYPE == 1]   <===    -->

                        <!--    ===>    FIELDSET 4 [CONFIRM NEW/EDIT TRANSPORT]    <===    -->
            <fieldset>
                <div class="form-card pt-0">
                    <div class="form-title row mt-2 pt-0 mx-auto">
                        <h2 class="fs-title"> 
                            <i class="bi bi-check"></i> 
                                &nbsp;Conferma&nbsp; 
                            <i class="bi bi-circle-check"></i> 
                        </h2>
                        
                        <h3 class="fs-subtitle pt-0 mt-0"> 
                            Confermare l'inserimento del nuovo trasporto. 
                        </h3>
                    </div>
                            <div class="col-lg-12">
                                Trasporto creato con successo!
                            </div>
                </div>
                    
                <button type="button" name="previous" class="previous action-button mb-3 mt-1" style="position: absolute; left: 4rem"> Indietro </button> 
                <button type="submit" name="submit" class="submit action-button mb-3 mt-1 mx-auto"> Salva </button>       
                <button type="button" class="reset action-button mb-3 mt-1" style="position: absolute; right: 4rem">
                    <a href="{{ doc_root }}admin/platform/" style="color: white"> Esci </a>
                </button> 
            </fieldset>
                        <!--    ===>    END FIELDSET 4 [CONFIRM NEW/EDIT TRANSPORT]    <===    -->
        </form>
    </section>
{% endblock %}    

{% block jsScript %}    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">      <!-- Bootstrap 5 CSS -->
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.1.4/dist/css/datepicker.min.css'>              <!-- Vanilla Datepicker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">          <!-- Vanilla Datepicker CSS -->
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker.min.js"></script>
    
<script>
    $(document).ready(function(){
//  ===> MULTI-STEP FIELDSET CHANGE      
        var current = 1, current_step, next_step, steps;
        steps = $("fieldset").length;

        //next fieldset in multi-step form
        $(".next").click(function(){
            current_step = $(this).parent();
                    
            if(current == '2' && $('#type option:selected').val() == 'F'){
                next_step = $(this).parent().next().next();
                ++current;
            } else{
                next_step = $(this).parent().next();
            }
                    
            next_step.show();
            current_step.hide();
            setProgressBar(++current);
        });

        //previous fieldset in multi-step form
        $(".previous").click(function(){
            current_step = $(this).parent();
            
            if(current == '4' && $('#type option:selected').val() == 'F'){
                next_step = $(this).parent().prev().prev();
                --current;
            } else{
                next_step = $(this).parent().prev();
            }

            next_step.show();
            current_step.hide();
            setProgressBar(--current);
        });
            
        //setting progress bar to % of current fieldset
        setProgressBar(current);
                
        //change progress bar action
        function setProgressBar(curStep){
            var percent = parseFloat(100 / steps) * curStep;
            percent = percent.toFixed();
                
            $(".progress-bar")
                .css("width",percent+"%")
                .html(percent+"%");     
        }
//  ===> END MULTI-STEP FIELDSET CHANGE     

//  ===> TOOLTIP CHARACTERISTICS   
        $("body").tooltip({ 
            selector: '[data-toggle = tooltip]',
            placement: 'right' 
        });
//  ===> END TOOLTIP CHARACTERISTICS

//  ===> PRICE_TYPOLOGY SELECT DISABLED CHANGE       
        $('#price_typology').change(function(){
            if($(this).val() == 'No'){
                $('#price_value').attr('disabled', true);
                $('#price_value').css({
                    'background': 'none',
                    'border': '1px solid rgb(160, 180, 185)',                
                });
                $('#price_value').val('0') == 0;
            } else{
                $('#price_value').attr('disabled', false);
                $('#price_value').css({
                    'background': '#fff',
                    'border': '1px solid #0066cc'
                });

                $("#price_value").focus(function(){
                    $("#price_value").css({
                        '-moz-box-shadow': '0 0 0 1px rgba(113,191,68) !important',
                        '-webkit-box-shadow': '0 0 0 1px rgba(113,191,68) !important',
                        'box-shadow': '0 0 0 1px rgba(113,191,68) !important',
                        'border': '1px solid #71bf44',
                        'outline-width': '0',
                        'transition': 'all 0.2s ease-out',
                        '-webkit-transition': 'all 0.2s ease-out',
                        '-moz-transition': 'all 0.2s ease-out',
                        '-o-transition': 'all 0.2s ease-out'
                    });
                });
            };
        });
//  ===> END PRICE_TYPOLOGY SELECT DISABLED CHANGE
        
//  ===> RESET BUTTON     
        $(".reset").click(function(){
            $("#price_value").val('');
            $("#price_value").attr('disabled', false);
            $("#price_value").css({
                'background': 'none',
                'border': '1px solid rgb(160, 180, 185)'
            });
        });
//  ===> END RESET BUTTON 
        
//  ===> DATEPICKER     
        //use datepicker on the date inputs
        $(".date").datepicker({
            format: 'dd-mm-yyyy',
            autoclose: true,
            todayHighlight: true,
            language: 'it-IT', 
        });
//  ===> END DATEPICKER   

//  ===> AJAX REQUEST TO INSERT ALL FORM DATA
        $('#submit').on('click', (function(){
            //e.preventDefault();
            $.ajax({
                method: 'post',
                url: 'admin/transport.php',
                data: $('#msform').serialize(),
                success: function(response){
                    console.log("Added!");
                }
            })
        }));
//  ===> END AJAX REQUEST TO INSERT ALL FORM DATA
    });   

//  ===> METHOD TO CREATE NEW ROW IN TABLE     
    //receives table id
    function addRowsTable(id){
        var table = document.getElementById(id);
        var me = this;
        
        if(document.getElementById(id)){
            var row1 = table.rows[1].outerHTML;
                
            //adds index-id in cols with name tbl_id
            function setIds(){
                var tbl_id = document.querySelectorAll('#'+ id +' tbl_id');
                        
                for(var i=0; i < tbl_id.length; i++) 
                    tbl_id[i].innerHTML = i+1;

                    $(".date").datepicker({
                        format: 'dd-mm-yyyy',
                        autoclose: true,
                        todayHighlight: true,
                        language: 'it-IT',
                    });
            }
                
            //add row after clicked row; receives clicked button in row
            me.addRow = function(btn){
                btn ? btn.parentNode.parentNode.insertAdjacentHTML('afterend', row1): table.insertAdjacentHTML('beforeend', row1);
                setIds();
            }
                
            //delete clicked row; receives clicked button in row
            me.delRow = function(btn){
                btn.parentNode.parentNode.outerHTML = '';
                setIds();
            }
        }
    }
//  ===> END METHOD TO CREATE NEW ROW IN TABLE   
           
    //create object of addRowsTable(), pass the table id
    var partRows = new addRowsTable('partials');    
</script> 
        
<!--    ===>    BOOTSTRAP DATEPICKER    <===    -->   
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" integrity="sha512-LsnSViqQyaXpD4mBBdRYeP6sRwJiJveh2ZIbW41EBrNmKxgr/LFZIiWT6yr+nycvhvauz8c2nYMhrP80YhG7Cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/locales/bootstrap-datepicker.it.min.js" charset="UTF-8"></script>
<!--    ===>    END BOOTSTRAP DATEPICKER    <===    --> 
{% endblock %}