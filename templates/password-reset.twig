{% extends 'layout.twig' %}
{% block title %} Login {% endblock %}

{% block body %}
<body id="login" class="d-flex justify-content-center align-items-center">
    <div class="container d-flex justify-content-center h-100">
        <div class="container col-4 my-auto user-card">
            
            <div class="container d-flex justify-content-center">
                <div class="d-flex justify-content-center logo-box">
                    <img src="/img/logo_liquimet.png" class="brand-logo" alt="Liquimet Logo">
                </div>
            </div>
            
            <div class="container form-box pb-5">
                <form id="reset-password-form" method="POST" action="password-reset" class="col-9 justify-content-center mx-auto my-auto" novalidate
                    autocomplete="off">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="token" value="{{ token }}">


                    <div class="input-group mx-auto my-2 input-login">
                        <label for="newPass" class="input-group-text">
                            <i class="bi bi-lock-fill"></i>
                        </label>
                        
                        <input type="password" id="newPass" name="newPass" placeholder="nuova password" autocomplete="off"
                            class="form-control {% if errors.newPass %}is-invalid{% endif %}" />   
                    </div>

                    <div class="error-placeholder small {% if errors.newPass %}alert alert-danger{% endif %}">
                        {% if errors.newPass %}{{ errors.newPass }}{% endif %}
                    </div>

                    <div class="input-group mx-auto my-2 input-login">
                        <label for="confirmPass" class="input-group-text">
                            <i class="bi bi-lock-fill"></i>
                        </label>
                        
                        <input type="password" id="confirmPass" name="confirmPass" placeholder="conferma password" autocomplete="off"
                            class="form-control {% if errors.confirmPass %}is-invalid{% endif %}" /> 
                    </div>

                    <div class="error-placeholder small {% if errors.confirmPass %}alert alert-danger{% endif %}">
                        {% if errors.confirmPass %}{{ errors.confirmPass }}{% endif %}
                    </div>

                    {# Error box with fixed height to prevent layout shift #}
                    <div class="my-3" style="min-height: 2rem;">
                        {% if success %}
                            <div id="errorBox" class="alert alert-success py-2 px-3">
                                <span class="mb-0">
                                    {{ success }}
                                </span>
                            </div>
                        {% else %}
                            <div id="errorBox" class="alert alert-danger d-none py-2 px-3">
                                <span class="mb-0"></span>
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-8 mx-auto my-4 btn-box">
                        <button type="submit" name="confirm" class="btn login-btn" id="confirm-btn" value="Conferma">
                            CONFERMA
                        </button>
                    </div>

                    <div class="mt-4">
                        <div class="d-flex justify-content-center links">
                            <a href="login" id="back-to-login">
                                &#60;&#60; Torna alla pagina di login &#62;&#62;
                            </a>
                        </div>
                    </div>
                </form>
            </div>	
        </div>
    </div>
</body>
{% endblock %}

{% block scripts %}
    {# jQuery (must be first) #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
        crossorigin="anonymous">
</script>
    {# jQuery Validation (depends on jQuery) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/jquery.validate.min.js" 
        integrity="sha512-KFHXdr2oObHKI9w4Hv1XPKc898mE4kgYx58oqsc/JqqdLMDI4YjOLzom+EMlW8HFUd0QfjfAvxSL6sEq/a42fQ==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer">
</script>
    {# jQuery Additional Methods (depends on jQuery) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/additional-methods.min.js" 
        integrity="sha512-owaCKNpctt4R4oShUTTraMPFKQWG9UdWTtG6GRzBjFV4VypcFi6+M3yc4Jk85s3ioQmkYWJbUl1b2b2r41RTjA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer">
</script>
<script>
$(document).ready(function() {
    $("#reset-password-form").validate({
        onfocusout: function(element) {
            $(element).valid();     
        },
        rules: {
            newPass: {
                required: true,
                minlength: 8,
                pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9!@#$%^&*(),.?\":{}|<>]).{8,}$"
            },
            confirmPass: {
                required: true,
                equalTo: "#newPass"
            }
        },
        messages: {
            newPass: {
                required: "Campo obbligatorio",
                minlength: "La password deve contenere almeno 8 caratteri",
                pattern: "Usare almeno 1 lettera maiuscola, 1 minuscola e 1 numero o carattere speciale"
            },
            confirmPass: {
                required: "Campo obbligatorio",
                equalTo: "La nuova password e la conferma non coincidono"
            }
        },
        errorPlacement: function (error, element) {
            element.addClass("is-invalid");                                             // Bootstrap error class
            element.closest(".input-group").find('.error-placeholder').html(error);      // Insert error inside the reserved space
        },
        highlight: function (element) {
            $(element).addClass('is-invalid');
            $(element).removeClass('is-valid');
        },
        unhighlight: function (element) {
            $(element).removeClass('is-invalid');
            $(element).addClass('is-valid');
            $(element).closest('.input-group').find('.error-placeholder').html('');
        },
        submitHandler: function(form) {
            // Prevent the form from submitting the traditional way
            event.preventDefault();

            // Send the form data via AJAX
            $.ajax({
                url: form.action, // URL from form action (password-reset)
                method: 'POST',
                data: $(form).serialize(), // Serialize form data
                dataType: 'json',
                success: function(response) {
                    // Handle server response
                    if (response.success) {
                        const success = $('.errorBox');
                        success.find('span').html(success);
                    } else if (response.errors) {
                        // If errors, show errors
                        $.each(response.errors, function (field, message) {
                            const input = $('[name="' + field + '"]');
                            input.addClass('is-invalid');
                            input.next('.error-placeholder').html('<div class="invalid-feedback">' + message + '</div>');
                        });
                    }
                },
                error: function() {
                    alert("Si Ã¨ verificato un errore. Riprovare.");
                }
            });
        }
    });
});
</script>
{% endblock %}