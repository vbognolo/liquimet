{% extends 'layout.twig' %}
{% block title %} Crea Trasporto {% endblock %}
{% block head %}
    {# Bootstrap Datepicker - CSS #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" 
        integrity="sha256-siyOpF/pBWUPgIcQi17TLBkjvNgNQArcmwJB8YvkAgg=" crossorigin="anonymous">
{% endblock %}
 
{% block content %} 
    {% include 'transports-navigation.twig' %}

    <section class="col-9 mx-auto register-form"> {# new-form class #}
        <div class="card">
            <div class="card-header row mx-auto pt-3">
                <h2 class="form-title mx-auto my-3"> 
                    <i class="bi bi-truck-front"></i> 
                        CREA NUOVO
                    <i class="bi bi-truck-front"></i> 
                </h2>


                <h4 id="step-subtitle" class="form-subtitle mx-auto my-2"> 
                    Inserire i dati richiesti per creare il nuovo <b style="color: #6d1741">trasporto</b>.
                </h4>
              
            </div>

            <form id="transport-form" method="POST" action="transport" autocomplete="off" novalidate>
                <input type="hidden" name="csrf_token" class="always-validate" value="{{ csrf_token }}">

                {# Fieldset 1 => Insert Transport #}   
                <fieldset class="mx-auto my-3 active" data-step="1">         
                    <div class="card-body">
                        <div class="row">
                            <div class="form-group col-md-4 mb-3">
                                <label for="type" class="form-control-label"> Tipo: </label>
                                <select name="type" id="type" 
                                    class="form-control {% if errors.type %}is-invalid{% endif %}">
                                        <option value="" class="opt-type" style="color: rgb(184,184,184);"> 
                                            - Selezionare un'opzione -
                                        </option>

                                        <option value="F" class="opt-type"> 
                                            PIENO
                                        </option>
                                            
                                        <option value="P" class="opt-type"> 
                                            PARZIALE
                                        </option>
                                </select>

                                <div class="error-placeholder">
                                    {% if errors.type %}<div class="invalid-feedback">{{ errors.type }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3">        
                                <label for="slot" class="form-control-label"> Slot ID: </label>
                                <input name="slot" type="text" id="slot"
                                    class="form-control {% if errors.slot %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.slot %}<div class="invalid-feedback">{{ errors.slot }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3">        
                                <label for="cmr" class="form-control-label"> Numero CMR: </label>
                                <input name="cmr" type="text" id="cmr"
                                    class="form-control {% if errors.cmr %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.cmr %}<div class="invalid-feedback">{{ errors.cmr }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3">         
                                <label for="issuer" class="form-control-label"> Ditta emittente: </label>
                                <input name="issuer" type="text" id="issuer"
                                    class="form-control {% if errors.issuer %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.issuer %}<div class="invalid-feedback">{{ errors.issuer }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3">         
                                <label for="supplier" class="form-control-label"> Fornitore: </label>
                                <input name="supplier" type="text" id="supplier"
                                    class="form-control {% if errors.supplier %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.supplier %}<div class="invalid-feedback">{{ errors.supplier }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3">         
                                <label for="transport" class="form-control-label"> Trasporto: </label>
                                <input name="transport" type="text" id="transport"
                                    class="form-control {% if errors.transport %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.transport %}<div class="invalid-feedback">{{ errors.transport }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3"> 
                                <label for="date_load" class="form-control-label" data-bs-toggle="tooltip" title="--> Terminale"> Data carico: </label>
                                <input name="date_load" type="text" id="date_load" 
                                    class="form-control datepicker {% if errors.date_load %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.date_load %}<div class="invalid-feedback">{{ errors.date_load }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3"> 
                                <label for="date_unload" class="form-control-label" data-bs-toggle="tooltip" title="--> Padova"> Data scarico: </label>
                                <input name="date_unload" type="text" id="date_unload" 
                                    class="form-control datepicker {% if errors.date_unload %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.date_unload %}<div class="invalid-feedback">{{ errors.date_unload }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-4 mb-3">         
                                <label for="container" class="form-control-label"> Container: </label>
                                <input name="container" type="text" id="container"
                                    class="form-control {% if errors.container %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.container %}<div class="invalid-feedback">{{ errors.container }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>          
                </fieldset>
                {# END Fieldset 1 => Insert Transport #}

                {# Fieldset 2 => Insert Quantity #}
                <fieldset class="mx-auto my-3" data-step="2">         
                    <div class="card-body">
                        <div class="row">
                            <div class="form-group col-md-6 mb-3">    
                                <label for="kg_load" data-bs-toggle="tooltip" title="--> Quantità nominale [ kg ]" class="form-control-label"> 
                                    Quantità caricata: 
                                </label>
                                <input name="kg_load" type="text" id="kg_load"
                                       class="form-control {% if errors.kg_load %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.kg_load %}<div class="invalid-feedback">{{ errors.kg_load }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-6 mb-3">
                                <label for="cooling" class="form-control-label"> Raffreddamento: </label>
                                <select name="cooling" id="cooling" class="form-control {% if errors.cooling %}is-invalid{% endif %}">
                                    <option value="" class="opt-type" style="color: lightgray;"> 
                                        - Selezionare un'opzione -
                                    </option>

                                    <option value="600" class="opt-type"> 
                                        SÌ = 600
                                    </option>
                                                
                                    <option value="0" class="opt-type"> 
                                        NO = 0
                                    </option>
                                </select>

                                <div class="error-placeholder">
                                    {% if errors.cooling %}<div class="invalid-feedback">{{ errors.cooling }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-6 mb-3">
                                <label for="price_typology" class="form-control-label"> Tipologia costo: </label>
                                <select name="price_typology" id="price_typology" class="form-control {% if errors.price_typology %}is-invalid{% endif %}">
                                    <option value="" class="opt-type" style="color: lightgray;"> 
                                        - Selezionare un'opzione -
                                    </option>

                                    <option value="yes" class="opt-type"> 
                                        SÌ
                                    </option>
                                                
                                    <option value="no" class="opt-type"> 
                                        NO
                                    </option>
                                </select>

                                <div class="error-placeholder">
                                    {% if errors.price_typology %}<div class="invalid-feedback">{{ errors.price_typology }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-6 mb-3">        
                                <label for="price_value" class="form-control-label"> Valore costo: </label>
                                <input name="price_value" type="text" id="price_value"
                                       class="form-control {% if errors.price_value %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.price_value %}<div class="invalid-feedback">{{ errors.price_value }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-6 mb-3">        
                                <label for="kg_unload" data-bs-toggle="tooltip" title="--> [ kg ]" class="form-control-label"> 
                                    Quantità scaricata: 
                                </label>
                                <input name="kg_unload" type="text" id="kg_unload"
                                       class="form-control {% if errors.kg_unload %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.kg_unload %}<div class="invalid-feedback">{{ errors.kg_unload }}</div>{% endif %}
                                </div>
                            </div>
                      
                            <div class="form-group col-md-6 mb-3">        
                                <label for="liquid_density" data-bs-toggle="tooltip" title="--> [ kg &frasl; m³ ]" class="form-control-label"> 
                                    Densità (liquido): 
                                </label>
                                <input name="liquid_density" type="text" id="liquid_density"
                                       class="form-control {% if errors.liquid_density %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.liquid_density %}<div class="invalid-feedback">{{ errors.liquid_density }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="form-group col-md-6 mb-3">        
                                <label for="gas_weight" data-bs-toggle="tooltip" title="--> [ kg &frasl; Nm³ ]" class="form-control-label"> 
                                    Peso specifico (gas): 
                                </label>
                                <input name="gas_weight" type="text" id="gas_weight"
                                       class="form-control {% if errors.gas_weight %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.gas_weight %}<div class="invalid-feedback">{{ errors.gas_weight }}</div>{% endif %}
                                </div>
                            </div>
   
                            <div class="form-group col-md-6 mb-3">        
                                <label for="pcs_ghv" data-bs-toggle="tooltip" title="--> [ kg &frasl; m³ ]" class="form-control-label"> 
                                    PCS/GHV: 
                                </label>
                                <input name="pcs_ghv" type="text" id="pcs_ghv"
                                       class="form-control {% if errors.pcs_ghv %}is-invalid{% endif %}" />

                                <div class="error-placeholder">
                                    {% if errors.pcs_ghv %}<div class="invalid-feedback">{{ errors.pcs_ghv }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                {# END Fieldset 2 => Insert Quantity #}

                {# Fieldset 3 => Insert Partial #}
                <fieldset class="mx-auto my-3" data-step="3">
                    <div class="card-body">
                        <div class="row table-responsive mx-auto my-2">     
                            <table class="table table-sm table-borderless platform" id="partials">
                                <thead>
                                    <tr class="mx-auto my-2">
                                        <th class="mx-auto"> <i class="bi bi-gear my-auto"></i> </th>
                                        <th class="mx-auto" data-bs-toggle="tooltip" title="--> Dest. cliente"> Destinazione </th>
                                        <th class="mx-auto"> EXW </th>
                                        <th class="mx-auto" data-bs-toggle="tooltip" title="--> Data scarico"> Data </th>
                                        <th class="mx-auto" data-bs-toggle="tooltip" title="--> Luogo scarico"> Luogo </th>
                                        <th class="mx-auto" data-bs-toggle="tooltip" title="--> Quantità scaricata [ kg ]"> Quantità </th>
                                        <th class="mx-auto" data-bs-toggle="tooltip" title="--> Fattura Rif."> Fattura </th>  
                                        <th class="mx-auto"></th>             
                                    </tr>
                                </thead>

                                <tbody>     
                                    <tr class="mx-auto">
                                        <td class="part-btns">
                                            <input type="hidden" name="id[]" id="id_partial" value="0"/>
                                        </td>
                                
                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="destination[]"
                                                class="form-control destination {% if errors.destination %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.destination %}<div class="invalid-feedback">{{ errors.destination }}</div>{% endif %}
                                            </div> 
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <select class="form-control exw {% if errors.exw %}is-invalid{% endif %}" name="exw[]" id="exw_0">
                                                <option value="" class="opt-type"></option>
                                                <option value="fos" class="opt-type"> FOS </option>
                                                <option value="destino" class="opt-type"> DESTINO </option>
                                            </select>
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="date[]"
                                                class="form-control datepicker date {% if errors.date %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.date %}<div class="invalid-feedback">{{ errors.date }}</div>{% endif %}
                                            </div> 
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="place[]"
                                                class="form-control place {% if errors.place %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.place %}<div class="invalid-feedback">{{ errors.place }}</div>{% endif %}
                                            </div> 
                                        </td>    

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="q_unloaded[]"
                                                class="form-control q_unloaded {% if errors.q_unloaded %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.q_unloaded %}<div class="invalid-feedback">{{ errors.q_unloaded }}</div>{% endif %}
                                            </div> 
                                        </td>       

                                        <td class="col-2 form-group mx-auto mb-3">
                                            <input type="text" name="invoice[]"
                                                class="form-control invoice {% if errors.invoice %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.invoice %}<div class="invalid-feedback">{{ errors.invoice }}</div>{% endif %}
                                            </div> 
                                        </td>                                                             
                                                    
                                        <td class="btns">
                                            <button type="button" class="my-auto px-1 edit-data delete-btn"
                                                {#}onclick="partRows.delRow(this)"#}>
                                                    <span class="my-auto">
                                                        <i class="bi bi-x-square"></i>
                                                    </span>
                                            </button>
                                        </td>
                                    </tr>

                                    <tr class="partial-row-template d-none">
                                        <td class="part-btns">
                                            <input type="hidden" name="id[]" value="0" />
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="destination[]"
                                                class="form-control destination {% if errors.destination %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.destination %}<div class="invalid-feedback">{{ errors.destination }}</div>{% endif %}
                                            </div> 
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <select class="form-control exw {% if errors.exw %}is-invalid{% endif %}" name="exw[]" id="exw_0">
                                                <option value="" class="opt-type"></option>
                                                <option value="fos" class="opt-type"> FOS </option>
                                                <option value="destino" class="opt-type"> DESTINO </option>
                                            </select>
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="date[]"
                                                class="form-control datepicker date {% if errors.date %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.date %}<div class="invalid-feedback">{{ errors.date }}</div>{% endif %}
                                            </div> 
                                        </td>

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="place[]"
                                                class="form-control place {% if errors.place %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.place %}<div class="invalid-feedback">{{ errors.place }}</div>{% endif %}
                                            </div> 
                                        </td>    

                                        <td class="col form-group mx-auto mb-3">
                                            <input type="text" name="q_unloaded[]"
                                                class="form-control q_unloaded {% if errors.q_unloaded %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.q_unloaded %}<div class="invalid-feedback">{{ errors.q_unloaded }}</div>{% endif %}
                                            </div> 
                                        </td>       

                                        <td class="col-2 form-group mx-auto mb-3">
                                            <input type="text" name="invoice[]"
                                                class="form-control invoice {% if errors.invoice %}is-invalid{% endif %}" />

                                            <div class="error-placeholder">
                                                {% if errors.invoice %}<div class="invalid-feedback">{{ errors.invoice }}</div>{% endif %}
                                            </div> 
                                        </td>                                                             
                                                    
                                        <td class="btns">
                                            <button type="button" class="my-auto px-1 edit-data delete-btn"
                                                {#}onclick="partRows.delRow(this)"#}>
                                                    <span class="my-auto">
                                                        <i class="bi bi-x-square"></i>
                                                    </span>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </fieldset>
                {# END Fieldset 3 => Insert Partial #}

                {# Fieldset 4 => Insert Note (Optional) #}
                <fieldset class="mx-auto my-3" data-step="4">         
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">    
                                <label for="note" class="form-control-label"> Nota: </label>
                                <textarea name="note" id="note" rows="1" 
                                          class="form-control {% if errors.note %}is-invalid{% endif %}"></textarea>

                                <div class="error-placeholder">
                                    {% if errors.note %}<div class="invalid-feedback">{{ errors.note }}</div>{% endif %}
                                </div>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="note" class="form-control-label my-1"> Nota </label>
                                <textarea name="note" id="note" class="form-control edit-note"  
                                          style="height: 80px; text-align: center; white-space-collapse: collapse"></textarea>
                            </div>
                        </div>
                    </div>
                </fieldset>
                {# END Fieldset 4 => Insert Note (Optional) #}

                {# Card Footer With Fieldset Buttons #}                      
                <div class="card-footer mx-auto">      
                    <button type="button" class="my-2 action-button prev">
                        <span class="m-auto">
                            <i class="bi bi-chevron-double-left"></i> INDIETRO
                        </span>
                    </button>
                            
                    <button type="button" class="my-2 action-button next">
                        <span class="m-auto">
                            AVANTI <i class="bi bi-chevron-double-right"></i>
                        </span>
                    </button>

                    <button type="submit" class="my-2 action-button save" name="save">
                        <span class="m-auto">
                            SALVA <i class="bi bi-chevron-double-right"></i>
                        </span>
                    </button>

                    <button type="button" class="my-2 action-button add" name="add" id="add-part" {#onclick="partRows.addRow()"#}>
                        <span class="m-auto">
                            AGGIUNGI <i class="bi bi-plus-circle"></i>
                        </span>
                    </button>
                </div> 
                {# END Card Footer With Fieldset Buttons #}
            </form>
        </div>
    </section>
{% endblock %}    

{% block jquery %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
            crossorigin="anonymous">
    </script>
        {# JQuery Validation #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/jquery.validate.min.js" 
            integrity="sha256-umbTaFxP31Fv6O1itpLS/3+v5fOAWDLOUzlmvOGaKV4=" 
            crossorigin="anonymous">
    </script>
        {# JQuery Validation Additional Methods #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.21.0/additional-methods.min.js" 
            integrity="sha256-MtEA819Zls6dtLt5S5BpEMOhifPyz7gfzfgtNtY75lE=" 
            crossorigin="anonymous">
    </script>
{% endblock %}

{% block datepicker %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" 
            integrity="sha256-bqVeqGdJ7h/lYPq6xrPv/YGzMEb6dNxlfiTUHSgRCp8=" 
            crossorigin="anonymous">
    </script>
{% endblock %}

{% block page_script %}
<script> 
$(document).ready(function () {
    // Step 3: Disable all inputs inside .partial-row-template to prevent accidental submission
    $('.partial-row-template').find('input, select, textarea').prop('disabled', true);



    $('[data-bs-toggle="tooltip"]').tooltip();

/***  Update header subtitle with fieldset change  ***/
    function formSubtitle() {
        const step = $('fieldset.active').data('step');
        let subtitle = '';

            switch (step) {
                case 1: subtitle = 'Inserire i dati richiesti per creare il nuovo <b style="color: #6d1741">trasporto</b>.'; break;
                case 2: subtitle = 'Inserire le <b style="color: #6d1741">quantità</b> del nuovo trasporto.'; break;
                case 3: subtitle = 'Inserire gli <b style="color: #6d1741">scarichi parziali</b> del nuovo trasporto.'; break;
                case 4: subtitle = 'Inserire la nota per il nuovo trasporto. (Non obbligatorio)'; break;
            }

        $('#step-subtitle').html(subtitle);
    }

/***  Update buttons on fieldset change  ***/
    function updateButtonVisibility() {
        const step = $('fieldset.active').data('step');

            //  Show/hide next/save
            if (step === 4) {
                $('.next').hide();
                $('.save').show();
            } else {
                $('.next').show();
                $('.save').hide();
            }

            //  Show AGGIUNGI only on step 3
            if (step === 3) {
                $('.add').show();
            } else {
                $('.add').hide();
            }
    }

/***  Update step flow when choosing type select input  ***/
    function updateStepFlow() {
        const type = $('#type').val();
        const full = type === 'F';

        //  Hide/show fieldset 3 (partials)
        const $trans    = $('fieldset[data-step="1"]');
        const $qty      = $('fieldset[data-step="2"]');
        const $partials = $('fieldset[data-step="3"]');
        const $note     = $('fieldset[data-step="4"]');

        //  Always show transport and quantity
        $trans.show();
        $qty.show();

            if (full) {
                $partials.hide();
                $note.show();
            } else {
                $partials.show();
                $note.show();
            }

        //  Reset active step to 1
        $('fieldset').removeClass('active').hide();
        $trans.addClass('active').show();

        formSubtitle();
        updateButtonVisibility();
    }


/***  Function to check transport availability by Slot ID and CMR Number  ***/
    /*function checkAvailability(field, value, id = null) {
        const csrfToken = $('input[name="csrf_token"]').val();

        $.ajax({
            url: "/check-transport",
            type: "POST",
            data: { [field]: value, id_transport: id, csrf_token: csrfToken },
            dataType: "json",
            success: function (response) {
                const inputField = $("#" + field);
                const errorPlaceholder = inputField.closest(".form-group").find(".error-placeholder");

                    if (response[field]) {
                        inputField.removeClass("is-valid").addClass("is-invalid");
                        errorPlaceholder.addClass("invalid-feedback").html(response[field]).show();
                    } else {
                        inputField.removeClass("is-invalid").addClass("is-valid");
                        errorPlaceholder.removeClass("invalid-feedback").hide();
                    }
            },
        });
    }*/

/***  Trigger validation when typing slot and cmr input fields  ***/
    /*let debounceTimer;
        $("#slot, #cmr").on("input", function () {
            clearTimeout(debounceTimer);
            let field = $(this).attr("id");
            let value = $(this).val();

                if (value.length >= 5) {
                    debounceTimer = setTimeout(() => {
                        checkAvailability(field, value);
                    }, 250); 
                }
        });*/

/***  Datepicker setup  ***/
    $('.datepicker').datepicker({
        format: 'dd-mm-yyyy',
        endDate: new Date(),
        autoclose: true,
        clearBtn: false 
    })
        .on('changeDate', function (e) {
            $(this).trigger('change');                                  // Validator catches the value
                if (this.id === 'date_load') {
                    $('#date_unload').datepicker('setStartDate', e.date)
                                     .datepicker('update', e.date);
                    }
                    $(this).valid(); 
    })
        .on('show', function () {
            $(this).data('selectedDate', $(this).val());                // Store current value when datepicker opens
    })
        .on('hide', function () {
            const currentVal = $(this).val();   
                if (!currentVal) {                                      // If the user didn't select anything and just clicked out, preserve current value
                    const storedDate = $(this).data('selectedDate');
                        if (storedDate) {
                            $(this).val(storedDate);                    // Restore value
                        }
                }
    });

/***  Quantity Price Value Toggle Field  ***/
    let switched = false;

    function togglePriceValueField() {
        const $pv = $('#price_value');
        const $pt = $('#price_typology');
        const typology = $pt.val();

        if (typology === 'no') {
            switched = true;
            $pv
                .val(0)
                .prop('disabled', true)
                .removeClass('is-valid is-invalid')
                .closest('.form-group')
                .find('.error-placeholder').html('');
        } else {
            $pv
                .prop('disabled', false)
                .removeClass('is-valid is-invalid')
                .closest('.form-group')
                .find('.error-placeholder').html('');

            if (switched) {
                $pv.val('');    // Clear value only if switched from no to yes
            }

            $pv.trigger('input'); // ensure initial sync
            switched = false;       // Reset flag after processing
        }
    }

    $('#price_typology').on('change', togglePriceValueField());

/***  Validation method for defining current date as max date  ***/
    $.validator.addMethod("noFutureDate", function (value, element) {
        if (!value) return true;                                            // Allow empty if not required

        const parts = value.split("-");
        const inputDate = new Date(parts[2], parts[1] - 1, parts[0]);       // Assuming dd-mm-yyyy
        const today = new Date();
        
        today.setHours(0, 0, 0, 0);                                         // Remove time part
            return inputDate <= today;
    });

/***  Validation method for defining that date_unload must be greater than or equal to date_load  ***/
    $.validator.addMethod("dateAfterOrEqual", function(value, element, params) {
        const dateLoadVal = $(params).val();
            if (!value || !dateLoadVal) return true;

        //  Parse dates as dd-mm-yyyy
        const partsUnload = value.split("-");
        const partsLoad = dateLoadVal.split("-");

        const dateUnload = new Date(partsUnload[2], partsUnload[1] - 1, partsUnload[0]);
        const dateLoad = new Date(partsLoad[2], partsLoad[1] - 1, partsLoad[0]);
            return this.optional(element) || dateUnload >= dateLoad;
    });

/***  Custom validation rule to ensure the "Selezionare un'opzione" option is not selected  ***/
    $.validator.addMethod("notPlaceholder", function(value, element) {
        return value !== "" && value !== "0";                   // Assuming '0' or '' represents the placeholder option value
    });

/***  Method for checking if e-mail already exists  ***/
    /*$.validator.addMethod("slotCheck", function (value, element) {
        const original = $('[name="original_email"]').val();
            if (value === original) return true;

        let isSuccess = false;
            $.ajax({
                url: 'check-slot',
                type: 'POST',
                data: { slot: value },
                dataType: 'json',
                async: false,
                success: function (response) {
                    isSuccess = response.available === true;
                }
            });
        return isSuccess;
    });*/
/***  Method for checking if partial date is between transport's date load and date unload  ***/
    $.validator.addMethod("dateRangeLoadUnload", function(value, element) {
        if (!value) return false;

        const regex = /^\d{2}-\d{2}-\d{4}$/;
            if (!regex.test(value)) return false;

        const [day, month, year] = value.split("-");
        const inputDate = new Date(year, month - 1, day);
            if (isNaN(inputDate)) return false;

        const loadVal = $('#date_load').val();
        const unloadVal = $('#date_unload').val();
            if (!loadVal || !unloadVal) return false;

        const [lday, lmonth, lyear] = loadVal.split("-");
        const [uday, umonth, uyear] = unloadVal.split("-");

        const loadDate = new Date(lyear, lmonth - 1, lday);
        const unloadDate = new Date(uyear, umonth - 1, uday);

        return inputDate >= loadDate && inputDate <= unloadDate;
    });

/***  Validator [JQuery Validation]  ***/
    const validator = $('#transport-form').validate({
        ignore: ":hidden:not(.always-validate)",                // Skip hidden fields unless forced
        onkeyup: false,
        onfocusout: function (element) {
            if ($(element).is(':visible')) {
                this.element(element);                          // Validate just this field
            }
        },
        onclick: false,
        rules: {
            // Transport
            slot: { required: true, rangelength: [5, 35], pattern: "^[A-Za-z0-9_]+$" },
            cmr: { required: true, rangelength: [5, 35], pattern: "^[A-Za-z0-9\-]+$" },
            type: { required: true },
            issuer: { required: true, rangelength: [3, 50], pattern: "^[A-Za-z][A-Za-z ]*$" },
            supplier: { required: true, rangelength: [3, 50], pattern: "^[A-Za-z][A-Za-z ]*$" },
            transport: { required: true, rangelength: [3, 50], pattern: "^[A-Za-z][A-Za-z ]*$" },
            date_load: { required: true, noFutureDate: true },
            date_unload: { required: true, noFutureDate: true, dateAfterOrEqual: "#date_load" },
            container: { required: true, rangelength: [3, 50], pattern: "^[A-Za-z][A-Za-z ]*$" },
            // Quantity
            kg_load: { required: true, number: true, min: 0 },
            cooling: { required: true },
            price_typology: { required: true },
            price_value: { 
                required: {
                    depends: function() {
                        return $('#price_typology').val() === 'yes';
                    }
                },
                digits: true,
                min: 1
            },
            kg_unload: { required: true, number: true, min: 0 },
            liquid_density: { required: true, number: true, min: 0 },
            gas_weight: { required: true, number: true, min: 0 },
            pcs_ghv: { required: true, number: true, min: 0 }
        },
        messages: {
            slot: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 5 e al massimo 35 caratteri.",
                pattern: "Slot ID può contenere lettere, numeri e underscore (_). Spazi non consentiti."
            },
            cmr: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 5 e al massimo 35 caratteri.",
                pattern: "CMR può contenere lettere, numeri e trattini (-). Spazi non consentiti."
            },
            type: {
                required: "Campo obbligatorio."
            },
            issuer: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 3 e al massimo 50 caratteri.",
                pattern: "Emittente può contenere solo lettere e spazi (senza spazio iniziale)."
            }, 
            supplier: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 3 e al massimo 50 caratteri.",
                pattern: "Fornitore può contenere solo lettere e spazi (senza spazio iniziale)."
            }, 
            transport: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 3 e al massimo 50 caratteri.",
                pattern: "Trasporto può contenere solo lettere e spazi (senza spazio iniziale)."
            },
            date_load: {
                required: "Campo obbligatorio.",
                noFutureDate: "Inserire una data valida. Non sono permesse date future."
            }, 
            date_unload: {
                required: "Campo obbligatorio.",
                noFutureDate: "Inserire una data valida. Non sono permesse date future.",
                dateAfterOrEqual: "La data di scarico non può essere precedente alla data di carico."
            }, 
            container: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 3 e al massimo 50 caratteri.",
                pattern: "Container può contenere solo lettere e spazi (senza spazio iniziale)."
            },
            kg_load: {
                required: "Campo obbligatorio.",
                number: "Quantità caricata deve essere un numero positivo (intero o decimale).",
                min: "Il valore minimo deve essere maggiore o uguale a 0."
            },
            cooling: {
                required: "Campo obbligatorio."//,
                //digits: "Raffreddamento deve essere un numero intero positivo, senza segni o decimali.",
                //notPlaceholder: "Selezionare un'opzione."
            },
            price_typology: {
                required: "Campo obbligatorio."
            }, 
            price_value: {
                required: "Campo obbligatorio.",
                digits: "Valore costo extra deve essere un numero intero positivo maggiore o uguale a 1, senza segni o decimali.",
                min: "Il valore minimo deve essere maggiore o uguale a 1."
            }, 
            kg_unload: {
                required: "Campo obbligatorio.",
                number: "Quantità scaricata deve essere un numero positivo (intero o decimale).",
                min: "Il valore minimo deve essere maggiore o uguale a 0."
            },
            liquid_density: {
                required: "Campo obbligatorio.",
                number: "Densità liquido deve essere un numero positivo (intero o decimale).",
                min: "Il valore minimo deve essere maggiore o uguale a 0.",
            }, 
            gas_weight: {
                required: "Campo obbligatorio.",
                number: "Peso specifico (gas) deve essere un numero positivo (intero o decimale).",
                min: "Il valore minimo deve essere maggiore o uguale a 0."
            }, 
            pcs_ghv: {
                required: "Campo obbligatorio.",
                number: "PCS/GHV deve essere un numero positivo (intero o decimale).",
                min: "Il valore minimo deve essere maggiore o uguale a 0."
            }
        },
        errorPlacement: function(error, element) {
            error.addClass("text-danger small");
            element.removeClass("is-valid").addClass("is-invalid");                                             
            element.closest(".form-group").find(".error-placeholder").html(error);      
        },
        highlight: function (element) {
            $(element).removeClass('is-valid').addClass('is-invalid');
        },
        unhighlight: function (element) {
            $(element).removeClass('is-invalid');
            $(element).closest('.form-group').find('.error-placeholder').html('');
        },
        invalidHandler: function (form, validator) {                // Only validate visible fieldset
            if (validator.errorList.length) {
                const firstError = validator.errorList[0].element;
                const errorStep = $(firstError).closest('fieldset').data('step');

                $('fieldset').removeClass('active').hide();
                const targetStep = $('fieldset[data-step="' + errorStep + '"]');

                targetStep.addClass('active').show();
                formSubtitle();
                updateButtonVisibility();

                    $('html, body').animate({
                        scrollTop: $(firstError).offset().top - 100
                    }, 250);
            }
        }
    });

/***  Add validation to dynamically added partial row  ***/
    function addValidationToPartialRow($row) {
        if ($row.hasClass('partial-row-template')) {
            return; // Skip validation on the hidden template
        }
        
        // Loop through inputs/selects inside the given row
        $row.find('input, select').each(function () {
            const name = $(this).attr('name');

            if (name.includes('destination')) {
                $(this).rules('add', {
                    required: true,
                    messages: { required: "Campo obbligatorio." }
                });
            }

            if (name.includes('exw')) {
                $(this).rules('add', {
                    required: true,
                    messages: { required: "Campo obbligatorio." }
                });
            }

            if (name.includes('date')) {
                $(this).rules('add', {
                    required: true,
                    noFutureDate: true,
                    dateRangeLoadUnload: true,
                    messages: {
                        required: "Campo obbligatorio.",
                        noFutureDate: "Inserire una data valida. Non sono permesse date future.",
                        dateRangeLoadUnload: 'La data deve essere tra carico e scarico.'
                    }
                });
            }

            if (name.includes('place')) {
                $(this).rules('add', {
                    required: true,
                    rangelength: [3, 50],
                    pattern: /^[A-Za-z][A-Za-z ]*$/,
                    messages: {
                        required: "Campo obbligatorio.",
                        rangelength: 'Min 3, max 50 caratteri.',
                        pattern: 'Solo lettere e spazi (senza spazio iniziale).'
                    }
                });
            }

            if (name.includes('q_unloaded')) {
                $(this).rules('add', {
                    required: true,
                    number: true,
                    min: 0,
                    messages: {
                        required: "Campo obbligatorio.",
                        number: 'Deve essere un numero valido.',
                        min: 'Non può essere negativo.'
                    }
                });
            }

            if (name.includes('invoice')) {
                $(this).rules('add', {
                    required: true,
                    messages: { required: "Campo obbligatorio." }
                });
            }
        });
        /*$row.find('.destination').rules("add", {
            required: true,
            rangelength: [3, 50],
            pattern: /^[A-Za-z ]+$/,
            messages: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 3 e al massimo 50 caratteri.",
                pattern: "Destinazione può contenere lettere e spazi (senza spazio iniziale)."
            }
        });
        $row.find('.exw').rules("add", {
            required: true,
            notPlaceholder: true,
            messages: { 
                required: "Campo obbligatorio.",
                notPlaceholder: "Selezionare un'opzione."
            }
        });
        $row.find('.date').rules("add", {
            required: true,
            noFutureDate: true,
            dateRangeLoadUnload: true,
            messages: {
                required: "Campo obbligatorio.",
                noFutureDate: "Inserire una data valida. Non sono permesse date future.",
                dateRangeLoadUnload: ""
            }
        });
        $row.find('.place').rules("add", {
            required: true,
            rangelength: [3, 50],
            pattern: /^[A-Za-z][A-Za-z ]*$/,
            messages: {
                required: "Campo obbligatorio.",
                rangelength: "Usare almeno 3 e al massimo 50 caratteri.",
                pattern: "Luogo può contenere solo lettere e spazi (senza spazio iniziale)."
            }
        });
        $row.find('.q_unloaded').rules("add", {
            required: true,
            number: true,
            messages: {
                required: "Campo obbligatorio.",
                number: "Quantità scaricata deve essere un numero positivo."
            }
        });
        $row.find('.invoice').rules("add", {
            required: true,
            number: true,
            messages: {
                required: "Campo obbligatorio.",
                number: "Fattura deve essere un numero positivo."
            }
        });

        // Set up datepicker again for the new row
        $row.find('.date').datepicker({
            format: 'dd-mm-yyyy',
            endDate: new Date(),
            autoclose: true
        });*/
    }

/***  Initialize validation on existing partial rows  ***/
    $('#partials tbody tr').not('.partial-row-template').each(function () {
        addValidationToPartialRow($(this));
    });


/***  Bind type selection to fieldsets  ***/
    $('#type').on('change', function () {
        updateStepFlow();
    });

/***  Bind next button to navigation  ***/
    $(".next").on('click', function () {
        const $current = $('fieldset.active');
        let allValid = true;

        $current.find(':input:visible').each(function() {
            if (!validator.element(this)) {
                allValid = false;
            }
        });

            if (!allValid) {
                return;  // stop navigation if validation fails
            }

        const currentStep = $current.data('step');
        let nextStep = currentStep + 1;

            // Skip step 3 if type === 'F'
            if (nextStep === 3 && $('#type').val() === 'F') {
                nextStep = 4;
            }

        $current.removeClass('active').hide();
        const $next = $('fieldset[data-step="' + nextStep + '"]');

            if ($next.length) {
                $next.addClass('active').show();
            }

        formSubtitle();
        updateButtonVisibility();

        $('html, body').animate({ scrollTop: 0 }, 200);
    });

/***  Bind previous button to navigation  ***/
    $(".prev").on('click', function () {
        const $current = $('fieldset.active');
        const currentStep = $current.data('step');
        let prevStep = currentStep - 1;

            // Skip step 3 going backward if type = 'F'
            if (prevStep === 3 && $('#type').val() === 'F') {
                prevStep = 2;
            }

        $current.removeClass('active').hide();

        const $prev = $('fieldset[data-step="' + prevStep + '"]');
            if ($prev.length) {
                $prev.addClass('active').show();
            }

        formSubtitle();
        updateButtonVisibility();

        $('html, body').animate({ scrollTop: 0 }, 200);
    });

/***  Reindex partial rows  ***/
    function reindexPartialRows() {
        $('#partials tbody tr').not('.partial-row-template').each(function(index) {
            $(this).find('input, select').each(function () {
                const baseName = $(this).attr('name');
                if (baseName && baseName.includes('[]')) {
                    const clean = baseName.replace('[]', '');
                    $(this).attr('name', clean + '[' + index + ']');
                }
            });
        });
    }

/*** Add new partial row on button click ***/
    $('.add').on('click', function () {
        const $template = $('.partial-row-template').clone()
            .removeClass('partial-row-template d-none')   // show it
            .removeAttr('style');                         // remove hidden style if any

        const $tbody = $('#partials tbody');

        // Clear fields and errors
        $template.find('input, select').val('');
        $template.find('.is-invalid').removeClass('is-invalid');
        $template.find('.invalid-feedback').remove();
        $template.find('.error-placeholder').empty();

        // Remove IDs to prevent duplicates
        $template.find('[id]').removeAttr('id');

        // Append and reindex
        $tbody.append($template);
        reindexPartialRows();

        // Reinit datepicker
        $template.find('.date').datepicker({
            format: 'dd-mm-yyyy',
            endDate: new Date(),
            autoclose: true
        });

        // Apply validation
        addValidationToPartialRow($template);
    });

/***  Delete partial row on delete button click  ***/
    $('#partials').on('click', '.delete-btn', function () {
        //const $rows = $('#partials tbody tr').not('.partial-row-template'); // exclude template row if any
        const $rows = $("#partials tbody tr").filter(function () {
            return !$(this).hasClass("partial-row-template") && $(this).css("display") !== "none";
        });

            if ($rows.length > 1) {
                const $row = $(this).closest('tr');

                // Remove validation
                $row.find('input, select').each(function () {
                    $(this).rules('remove');
                });

                $row.remove();

                // Reindex again
                reindexPartialRows();
            } else {
                alert('Deve esserci almeno una riga di scarico parziale.');
            }
    });

//  On submit validate form and AJAX form submission
    $("#transport-form").submit(function (e) {
        e.preventDefault();                             // Prevent the default form submission

        if ($(this).valid()) {
            // Clone the form without the template row
            const $clonedForm = $('#transport-form').clone();

            // Remove .partial-row-template rows before serializing
            $clonedForm.find('.partial-row-template').remove();

            // Now safely serialize only real input fields
            const formData = $clonedForm.serialize();

            $.ajax({
                url: $(this).attr("action"),            // PHP file to handle the submission
                type: 'POST',
                data: formData,
                dataType: "json",
                success: function(response) {
                    if (response.success) {        
                        //  Encode the new ID
                        const created = encodeURIComponent(response.created);
        
                        //  Redirect to users page with newId in the query string
                        window.location.href = '/platform?created=' + created + '#id-' + created;
                        document.getElementById('id-' + response.created)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else if (response.errors) {
                        // Clear old validation errors
                        $(".invalid-feedback").remove();
                        $("input, select, textarea").removeClass("is-invalid");

                        // Process each error field
                        $.each(response.errors, function(field, message) {
                            // Match field like "destination[1]"
                            const match = field.match(/^([^\[]+)\[(\d+)\]$/);
                            if (match) {
                                const baseName = match[1];       
                                const idx = parseInt(match[2], 10) - 1;   // <-- subtract 1 here

                                const $rows = $("#partials tbody tr").not(".partial-row-template");

                                if (idx >= 0 && idx < $rows.length) {
                                    const $row = $rows.eq(idx);
                                    const $input = $row.find('[name="' + baseName + '[]"]');

                                        if ($input.length) {
                                            $input.addClass("is-invalid");
                                            $input.next(".invalid-feedback").remove();
                                            $input.after('<div class="invalid-feedback">' + message + '</div>');
                                        }
                                }
                            } else {
                                // Non-array field errors, unchanged
                                const $input = $('[name="' + field + '"]');

                                    if ($input.length) {
                                        $input.addClass("is-invalid");
                                        $input.next(".invalid-feedback").remove();
                                        $input.after('<div class="invalid-feedback">' + message + '</div>');
                                    }
                            }
                        });
                    }
                },
                error: function(xhr) {
                    alert('Error: ' + xhr.responseText);
                }
            });
        }
    });
    
    /***  Initial functions for Form Subtitle and Button Change on Fieldset  ***/
    formSubtitle();
    updateButtonVisibility();
    updateStepFlow();
});

/***  Method to add new partial rows  ***/     
    //receives table id
    /*function addRowsTable(id){
        var table = document.getElementById(id);
        var me = this;
        
        if(document.getElementById(id)){
            var row1 = table.rows[1].outerHTML;
                
            //adds index-id in cols with class .tbl_id
            function setIds(){
                var tbl_id = document.querySelectorAll('#'+ id +' .tbl_id');
                        
                for(var i=0; i < tbl_id.length; i++) 
                    tbl_id[i].innerHTML = i+1;

                    $(".date").datepicker({
                        format: 'dd-mm-yyyy',
                        autoclose: true,
                        todayHighlight: true,
                        language: 'it-IT',
                    });
            }
                
            //add row after clicked row; receives clicked button in row
            me.addRow = function(btn){
                btn ? btn.parentNode.parentNode.insertAdjacentHTML('afterend', row1): table.insertAdjacentHTML('beforeend', row1);
                setIds();
            }
                
            //delete clicked row; receives clicked button in row
            me.delRow = function(btn){
                btn.parentNode.parentNode.outerHTML = '';
                setIds();
            }
        }
    }  */
           
/***  create object of addRowsTable(), pass the table id  ***/
    /*var partRows = new addRowsTable('partials');  */
</script> 
{% endblock %}