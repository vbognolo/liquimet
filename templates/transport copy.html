{% extends 'layout.html' %}
{% block title %} Crea Trasporto {% endblock %}

{% block search %}
    <!--    ===>    SEARCH BAR    <===    -->
    <section class="row my-auto mx-auto search-header" style="border: 1px solid red">
        <div class="my-auto m-0 search-bar">
            <form id="search-form">
                <button type="button" class="my-1 search-btn">
                    <i class="bi bi-search"></i>
                </button>
                <input type="text" class="my-1 search-input" id="search" placeholder="      Cerca.." />  
            </form>
        </div>
    </section>
    <!--    ===>    END SEARCH BAR    <===    -->
{% endblock %}

{% block content %} 
    {{ include('transports-navigation.html') }}

    <section class="col-9 mx-auto my-0 new-form">
        <form id="trans-form" action="transport" method="POST" autocomplete="off">

            <!--    =====>    PROGRESS BAR    <=====    -->
            <!--<div class="container col-8 mx-auto my-1">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>-->
            <!--    =====>    END PROGRESS BAR    <=====    -->

            <!--    =====>    FIELDSET 1 [ADD/EDIT TRANSPORT]    <=====    -->
            <fieldset class="mx-auto my-3">
                <div class="card">
                    <div class="card-header row mx-auto pt-3">
                        <h2 class="form-title mx-auto my-2"> 
                            <i class="bi bi-truck-front"></i> 
                                CREA NUOVO
                            <i class="bi bi-truck-front"></i> 
                        </h2>
                    
                            <h4 class="form-subtitle mx-auto my-2"> 
                                Inserire i dati richiesti per creare il nuovo <b style="color: #6d1741">trasporto</b>.
                            </h4>
                    </div>

                    <div class="card-body row">
                        <div class="col-12 mx-auto my-2">     
                            <div class="row mx-auto my-2">
                                <div class="col-6 my-1">
                                    <!-- error['SLOT'] number -->
                                    <div class="my-auto mx-0 px-0 err-circle" id="errSlotNum">
                                        <span class="alert my-1 mx-0 err-circle-span" role="alert"></span>
                                    </div>
                                    <!--  end  -->
                                    <label for="slot" class="form-control-label my-1"> Slot ID </label>
                                    <input type="text" class="form-control" name="slot" id="slot" />
                                </div>
                                                
                                <div class="col-6 my-1">
                                    <label for="cmr" class="form-control-label my-1"> Numero CMR </label>
                                    <input type="text" class="form-control" name="cmr" id="cmr" />
                                </div>
                            </div>

                            <div class="row mx-auto my-2">
                                <div class="col-3 my-1">
                                    <label for="type" class="form-control-label my-1"> Tipo </label>
                                        <select class="form-control" name="type" id="type">
                                            <option class="opt-type"></option>   
                                            
                                            <option value="F" class="opt-type"> 
                                                PIENO
                                            </option>
                                                
                                            <option value="P" class="opt-type"> 
                                                PARZIALE
                                            </option>
                                        </select>
                                </div>
                                                
                                <div class="col-3 my-1">
                                    <label for="issuer" class="form-control-label my-1"> Ditta emittente </label>
                                    <input type="text" class="form-control" name="issuer" id="issuer" />
                                </div>
                                            
                                <div class="col-3 my-1">
                                    <label for="supplier" class="form-control-label my-1"> Fornitore </label>
                                    <input type="text" class="form-control" name="supplier" id="supplier" />
                                </div>

                                <div class="col-3 my-1">
                                    <label for="transport" class="form-control-label my-1"> Trasporto </label>
                                    <input type="text" class="form-control" name="transport" id="transport" />
                                </div>
                            </div>

                            <div class="row mx-auto my-2">
                                <div class="col-4 my-1">
                                    <label for="date_load" class="form-control-label my-1" data-toggle="tooltip" title="--> Terminale"> Data carico </label>
                                    <input type="text" class="form-control date" name="date_load" id="date_load" />
                                </div>
                                                
                                <div class="col-4 my-1">
                                    <label for="date_unload" class="form-control-label my-1" data-toggle="tooltip" title="--> Padova"> Data scarico </label>
                                    <input type="text" class="form-control date" name="date_unload" id="date_unload" />
                                </div>

                                <div class="col-4 my-1">
                                    <label for="container" class="form-control-label my-1"> Container </label>
                                    <input type="text" class="form-control" name="container" id="container" />
                                </div>
                            </div>

                            <div class="row mx-auto my-2">
                                <div class="col-12 my-1">
                                    <label for="note" class="form-control-label my-1"> Nota </label>
                                    <textarea rows="1" class="form-control" name="note" id="note"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="action-button next trans-next" name="next">
                    <span class="m-auto">
                        AVANTI <i class="bi bi-chevron-double-right"></i>
                    </span>
                </button>
            </fieldset>
        
            <!--    =====>    END FIELDSET 1 [ADD/EDIT TRANSPORT]    <=====    -->

            <!--    =====>    FIELDSET 2 [ADD/EDIT QUANTITY]    <=====    -->
       
            <fieldset class="mx-auto my-3">
                <div class="card">
                    <div class="card-header row mx-auto pt-3">
                        <h2 class="form-title mx-auto my-2"> 
                            <i class="bi bi-truck"></i> 
                                CREA NUOVO
                            <i class="bi bi-truck"></i> 
                        </h2>
                    
                            <h4 class="form-subtitle mx-auto my-2"> 
                                Inserire le <b style="color: #6d1741">quantità</b> del nuovo trasporto. 
                            </h4>
                    </div>

                    <div class="card-body row">
                        <div class="col-12 mx-auto my-2">     
                            <div class="row mx-auto my-2">
                                <div class="col-6 my-1">
                                    <label for="kg_load" class="form-control-label my-1" data-toggle="tooltip" title="--> Quantità nominale [ kg ]"> 
                                        Quantità caricata 
                                    </label>
                                        <input type="text" class="form-control" name="kg_load" />
                                </div>  

                                <div class="col-6 my-1">
                                    <label for="cooling" class="form-control-label my-1"> Raffreddamento </label>
                                        <select class="form-control" name="cooling" id="cooling">
                                            <option class="opt-type" value=""></option>   
                                        
                                            <option value="600" class="opt-type"> 
                                                SÌ = 600
                                            </option>
                                            
                                            <option value="0" class="opt-type"> 
                                                NO = 0
                                            </option>
                                        </select>
                                </div>  
                            </div>

                            <div class="row mx-auto my-3">
                                <div class="col-6 my-1">
                                    <label class="form-control-label my-1" for="price_typology"> Tipologia costo </label>
                                        <select class="form-control" name="price_typology" id="price_typology">
                                            <option class="opt-type" value=""></option>
                                            
                                            <option class="opt-type" value="yes">
                                                SÌ
                                            </option>
                                            
                                            <option class="opt-type" value="no">
                                                NO
                                            </option>
                                        </select>
                                </div> 
    
                                <div class="col-6 my-1">
                                    <label for="price_value" class="form-control-label my-1 price_value"> 
                                        Valore costo 
                                    </label>
                                        <input type="text" class="form-control" name="price_value" id="price_value" value="" />
                                </div>
                            </div>

                            <div class="row mx-auto my-3">
                                <div class="col-6 my-1">
                                    <label for="kg_unload" class="form-control-label my-1" data-toggle="tooltip" title="-- [ kg ]"> 
                                        Quantità scaricata PD 
                                    </label>
                                        <input type="text" class="form-control" name="kg_unload" value=""/>
                                </div>
    
                                <div class="col-6 my-1">
                                    <label for="liquid_density" class="form-control-label my-1" data-toggle="tooltip" title="-- [ kg &frasl; m³ ]"> 
                                        Densità (liquido) 
                                    </label>
                                        <input type="text" class="form-control" name="liquid_density" value=""/>
                                </div>
                            </div>

                            <div class="row mx-auto my-3">
                                <div class="col-6 my-1">
                                    <label for="gas_weight" class="form-control-label my-1" data-toggle="tooltip" title="-- [ kg &frasl; Nm³ ]"> 
                                        Peso specifico (gas)
                                    </label>
                                        <input type="text" class="form-control" name="gas_weight" value=""/>
                                </div>

                                <div class="col-6 my-1">
                                    <label for="pcs_ghv" class="form-control-label my-1"> 
                                        PCS/GHV 
                                    </label>
                                        <input type="text" class="form-control" name="pcs_ghv" value=""/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="action-button back" name="back">
                    <span class="m-auto">
                        <i class="bi bi-chevron-double-left"></i> INDIETRO
                    </span>
                </button>

                <button type="button" class="action-button next" name="next" id="qty-next">
                    <span class="m-auto">
                        AVANTI <i class="bi bi-chevron-double-right"></i>
                    </span>
                </button>

                <button type="submit" class="action-button save" name="save" id="qty-save">
                    <span class="m-auto">
                        SALVA <i class="bi bi-check-circle"></i>
                    </span>
                </button>
            </fieldset>
        
            <!--    =====>    END FIELDSET 2 [ADD/EDIT QUANTITY]    <=====    -->

             <!--    =====>    FIELDSET 3 [ADD/EDIT PARTIAL IF TYPE = 1]    <=====    -->
       
            <fieldset class="mx-auto my-3">
                <div class="card">
                    <div class="card-header row mx-auto pt-3">
                        <h2 class="form-title mx-auto my-2"> 
                            <i class="bi bi-truck-flatbed"></i>
                                CREA NUOVO
                            <i class="bi bi-truck-flatbed"></i>
                        </h2>
                    
                            <h4 class="form-subtitle mx-auto my-2"> 
                                Inserire gli <b style="color: #6d1741">scarichi parziali</b> del nuovo trasporto. 
                            </h4>
                    </div>

                    <div class="card-body my-3">
                        <div class="row table-responsive mx-auto my-2">     
                            <table class="table table-sm table-borderless" id="partials">
                                <tr class="mx-auto my-2">
                                    <th class="mx-auto"> <i class="bi bi-gear my-auto"></i> </th>
                                    <th class="mx-auto" data-toggle="tooltip" title="--> Dest. cliente"> Destinazione </th>
                                    <th class="mx-auto"> EXW </th>
                                    <th class="mx-auto" data-toggle="tooltip" title="--> Data scarico"> Data </th>
                                    <th class="mx-auto" data-toggle="tooltip" title="--> Luogo scarico"> Luogo </th>
                                    <th class="mx-auto" data-toggle="tooltip" title="--> Quantità scaricata [ kg ]"> Quantità </th>
                                    <th class="mx-auto" data-toggle="tooltip" title="--> Fattura Rif."> Fattura </th>  
                                    <th class="mx-auto"> <i class="bi bi-gear my-auto"></i> </th>             
                                </tr>
                                  
                                <tr class="mx-auto my-1">
                                    <td class="part-btns">
                                        <input type="hidden" name="tbl_id[]" value="" id="id_partial" />
                                            <button type="button" class="my-auto px-1 add-btn"
                                                onclick="partRows.addRow(this)">
                                                    <span class="my-auto">
                                                        <i class="bi bi-plus-square"></i>
                                                    </span> 
                                            </button>
                                    </td>
                              
                                    <td class="col-3">
                                        <input type="text" name="destination[]" class="form-control" value=""/> 
                                    </td>
    
                                    <td class="col-2">
                                        <select class="form-control" name="exw[]">
                                            <option value=""></option>
                                            <option value="fos"> FOS </option>
                                            <option value="destino"> DESTINO </option>
                                        </select>
                                    </td>
                                                
                                    <td class="col-2"> 
                                        <input type="text" class="form-control date" name="date[]" autocomplete="off" value=""/>
                                    </td>
                            
                                    <td class="col-2">
                                        <input type="text" class="form-control" name="place[]" value="" />
                                    </td>
                            
                                    <td class="col-2">
                                        <input type="text" class="form-control mx-auto" name="q_unloaded[]" value="" />
                                    </td>
                            
                                    <td class="col mx-auto">
                                        <input type="text" class="form-control mx-auto" name="invoice[]" value=""/>
                                    </td>

                                    <td class="part-btns">
                                        <button type="button" class="my-auto px-1 delete-btn"
                                            onclick="partRows.delRow(this)">
                                                <span class="my-auto">
                                                    <i class="bi bi-x-square"></i>
                                                </span>
                                        </button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <button type="button" class="action-button back">
                    <span class="m-auto">
                        <i class="bi bi-chevron-double-left"></i> INDIETRO
                    </span>
                </button>

                <button type="button" class="action-button add" onclick="partRows.addRow()">
                    <span class="m-auto">
                        AGGIUNGI <i class="bi bi-plus-circle"></i>
                    </span>
                </button>
    
                <button type="submit" class="action-button save" name="save">
                    <span class="m-auto">
                        SALVA <i class="bi bi-check-circle"></i>
                    </span>
                </button>
            </fieldset>
            <!--    =====>    END FIELDSET 3 [ADD/EDIT PARTIAL IF TYPE = 1]    <=====    -->

            <!--    =====>    FIELDSET 4 [CONFIRM NEW TRANSPORT]    <=====    -->

            <!--    =====>    END FIELDSET 4 [CONFIRM NEW TRANSPORT]    <=====    -->
        </form>
    </section>
{% endblock %}    

{% block jsScript %}    
<!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">      <!-- Bootstrap 5 CSS -->
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.1.4/dist/css/datepicker.min.css'>              <!-- Vanilla Datepicker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">          <!-- Vanilla Datepicker CSS -->
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker.min.js"></script>
    
<script>
$(document).ready(function(){
    $(".trans-next").on('click', function(){
        //e.preventDefault();
        var slot = $("#slot").val();
        var type = $("#type").val();
        var cmr = $("#cmr").val();
        var issuer = $("#issuer").val();
        var supplier = $("#supplier").val();
        var transport = $("#transport").val();
        var date_load = $("#date_load").val();
        var date_unload = $("#date_unload").val();
        var container = $("#container").val();
        var note = $("#note").val();

                $.ajax({
                    type: 'POST',
                    url: 'validate-transport.php',
                    data: $("#trans-form").serialize()
                        /*type: type,
                        slot: slot,
                        cmr: cmr,
                        issuer: issuer,
                        supplier: supplier,
                        transport: transport,
                        date_load: date_load,
                        date_unload: date_unload,
                        container: container,
                        note: note*/
                    ,
                    success: function(response){
                        console.log(response);
                    }
                });
    });
    
//  ===> MULTI-STEP FIELDSET CHANGE      
    var current = 1;
    var current_field, next_field, previous_field;
    var fields = $("fieldset").length;
    
        //btn for next fieldset in multi-step form
        $(".next").on('click', function(){
            current_field = $(this).closest("fieldset");
            next_field = current_field.next();

                if(current == '1' && $("#type option:selected").val() == 'F'){
                    $("#qty-next").css("display", "none");
                    $("#qty-save").css("display", "block");
                        ++current;
                } else{
                    $("#qty-save").css("display", "none");
                    $("#qty-next").css("display", "block");
                };
                    
            next_field.show();
            current_field.hide();
            //setProgressBar(++current);
        });

        //btn for previous fieldset in multi-step form
        $(".back").on('click', function(){
            current_field = $(this).closest("fieldset");
            previous_field = current_field.prev();

                if(current == '2' && $("#type option:selected").val() == 'F'){
                    $("#qty-next").css("display", "none");
                    $("#qty-save").css("display", "block");
                        --current;
                } else{
                    $("#qty-save").css("display", "none");
                    $("#qty-next").css("display", "block");
                };
                    
            previous_field.show();
            current_field.hide();
            //setProgressBar(--current);
        });
            
    //setting progress bar to % of current fieldset
    //setProgressBar(current);
                
        //change progress bar action
    /*    function setProgressBar(currentField){
            var percent = parseFloat(100 / fields) * currentField;
            percent = percent.toFixed();
                
            $(".progress-bar")
                .css("width", percent + "%")
                .html(percent + "%");     
        }*/
//  ===> END MULTI-STEP FIELDSET CHANGE     

//  ===> TOOLTIP CHARACTERISTICS   
    $("body").tooltip({ 
        selector: '[data-toggle = tooltip]',
        placement: 'right' 
    });
//  ===> END TOOLTIP CHARACTERISTICS

//  ===> SELECT CHANGE
    $('#price_typology').on('change', function(){
        if($('#price_typology option:selected').val() == 'no'){
            //$('#price_typology option[value=no]').attr('selected', true);
            $('#price_value').attr('disabled', true);
            $('#price_value').css({
                'background': 'none',
                'border': '1px solid rgba(76, 103, 130, 0.35)',
                'border-radius': '0.5rem'               
            });
            $('#price_value').val('0') == 0;
        } else{
            //$('#price_typology option[value=yes]').attr('selected', true);
            $('#price_value').attr('disabled', false);
            $('#price_value').css({
                'background': '#ffffff',
                'border': '1px solid rgba(76, 103, 130, 0.35)',
                'border-radius': '0.5rem'
            });
            $('#price_value').val('');

            $("#price_value").focus(function(){
                $("#price_value").css({
                    '-moz-box-shadow': '0 0 0 1px rgba(113,191,68) !important',
                    '-webkit-box-shadow': '0 0 0 1px rgba(113,191,68) !important',
                    'box-shadow': '0 0 0 1px rgba(113,191,68) !important',
                    'border': '1px solid #71bf44',
                    'outline-width': '0',
                    'transition': 'all 0.2s ease-out',
                    '-webkit-transition': 'all 0.2s ease-out',
                    '-moz-transition': 'all 0.2s ease-out',
                    '-o-transition': 'all 0.2s ease-out'
                });
            });
        };
    });
//  ===> END PRICE_TYPOLOGY SELECT DISABLED CHANGE
        
//  ===> DATEPICKER     
    //use datepicker on the date inputs
    $(".date").datepicker({
        format: 'dd-mm-yyyy',
        autoclose: true,
        todayHighlight: true,
        language: 'it-IT', 
    });
//  ===> END DATEPICKER   

//  ===> PREVIEW INSERTED DATA
//$('.preview').click(function(){
 //           var formValues = [];
            
            //get values from inputs in first and second fieldset
 //           $('.field1 :input, .field2 :input').each(function(){
  //              formValues.push($(this).val());
  //          });
                    
  //          formValues.pop();               //remove the button from input values
   //         console.log(formValues);
                    
            //set values in second fieldset
   //         $('.field3 :input').each(function(index){
   //             if(formValues[index]){
   //                 $(this).val(formValues[index]);  
   //             }
   //         });
   //     });
});   

//  ===> METHOD TO CREATE NEW ROW IN TABLE     
    //receives table id
    function addRowsTable(id){
        var table = document.getElementById(id);
        var me = this;
        
        if(document.getElementById(id)){
            var row1 = table.rows[1].outerHTML;
                
            //adds index-id in cols with name tbl_id
            function setIds(){
                var tbl_id = document.querySelectorAll('#'+ id +' tbl_id');
                        
                for(var i=0; i < tbl_id.length; i++) 
                    tbl_id[i].innerHTML = i+1;

                    $(".date").datepicker({
                        format: 'dd-mm-yyyy',
                        autoclose: true,
                        todayHighlight: true,
                        language: 'it-IT',
                    });
            }
                
            //add row after clicked row; receives clicked button in row
            me.addRow = function(btn){
                btn ? btn.parentNode.parentNode.insertAdjacentHTML('afterend', row1): table.insertAdjacentHTML('beforeend', row1);
                setIds();
            }
                
            //delete clicked row; receives clicked button in row
            me.delRow = function(btn){
                btn.parentNode.parentNode.outerHTML = '';
                setIds();
            }
        }
    }

    //create object of addRowsTable(), pass the table id
    var partRows = new addRowsTable('partials');    
//  ===> END METHOD TO CREATE NEW ROW IN TABLE  

//  ===> METHOD TO VALIDATE MULTISTEP FORM
    function validateTransport(){
            //  ===> AJAX REQUEST TO VALIDATE TRANSPORT FORM DATA
            //$(".trans-next").on('click', function(){
                //e.preventDefault();
                var transport = [
                    'slot' = $("#slot").val(),
                    'type' = $("#type").val(),
                    'cmr' = $("#cmr").val(),
                    'issuer' = $("#issuer").val(),
                    'supplier' = $("#supplier").val(),
                    'transport' = $("#transport").val(),
                    'date_load' = $("#date_load").val(),
                    'date_unload' = $("#date_unload").val(),
                    'container' = $("#container").val(),
                    'note' = $("#note").val(),
                ];
                /*var slot = $("#slot").val();
                var type = $("#type").val();
                var cmr = $("#cmr").val();
                var issuer = $("#issuer").val();
                var supplier = $("#supplier").val();
                var transport = $("#transport").val();
                var date_load = $("#date_load").val();
                var date_unload = $("#date_unload").val();
                var container = $("#container").val();
                var note = $("#note").val();*/

                $.ajax({
                    type: 'POST',
                    url: 'validate-transport.php',
                    data: $("#trans-form").serialize(), /*{ 
                        type: type,
                        slot: slot,
                        cmr: cmr,
                        issuer: issuer,
                        supplier: supplier,
                        transport: transport,
                        date_load: date_load,
                        date_unload: date_unload,
                        container: container,
                        note: note
                    },*/
                    success: function(response){
                        console.log(response);
                    }
                });
            //});
            //  ===> END AJAX REQUEST TO VALIDATE TRANSPORT FORM DATA
    }
//  ===> END METHOD TO VALIDATE MULTISTEP FORM
</script> 
        
<!--    ===>    BOOTSTRAP DATEPICKER    <===    -->   

{% endblock %}